name: ğŸš€ Self-hosted Auto Deploy

on:
  push:
    branches: [ "main" ]  # main ë¸Œëœì¹˜ì— ì˜¬ë¦´ ë•Œë§Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: self-hosted  # ğŸ‘ˆ ì„œë²„ì— ì‹¬ì–´ë‘” ë¡œë´‡(Runner)ì´ ì‘ë™
    
    steps:
      - name: 1. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v3
      
      - name: 2. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (.env)
        # ê¹ƒí—ˆë¸Œ Secretsì— ì €ì¥ëœ ë‚´ìš©ì„ êº¼ë‚´ì„œ íŒŒì¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
        run: echo "${{ secrets.ENV_FILE }}" > .env

      - name: 3. Docker Compose ì¬ì‹¤í–‰
        run: |
          echo "ğŸ”¥ ê¸°ì¡´ ì„œë²„ ì¢…ë£Œ..."
          # (-f): ì„¤ì • íŒŒì¼ì€ '/home/hcoh990310/'ì— ìˆëŠ” ê±¸ ì”ë‹ˆë‹¤.
          sudo docker compose -f /home/hcoh990310/docker-compose.yml down
          
          echo "ğŸ—ï¸ ìƒˆë¡œ ë¹Œë“œí•˜ê³  ì‹œì‘..."
          # [í•µì‹¬] ì„¤ì • íŒŒì¼(-f)ì€ í™ˆ ë””ë ‰í† ë¦¬ë¥¼ ë³´ì§€ë§Œ, 
          # ë¹Œë“œ ìœ„ì¹˜(--project-directory)ëŠ” 'ì§€ê¸ˆ ì—¬ê¸°(ì†ŒìŠ¤ì½”ë“œ í´ë”)'ë¡œ ì§€ì •í•©ë‹ˆë‹¤.
          # ì´ê±¸ í•´ì•¼ gradlewë¥¼ ì°¾ì„ ìˆ˜ ìˆê³ , ë¹Œë“œê°€ ë¹¨ë¼ì§‘ë‹ˆë‹¤.
          sudo docker compose -f /home/hcoh990310/docker-compose.yml --project-directory . up -d --build
          
          echo "ğŸ§¹ ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì²­ì†Œ..."
          sudo docker image prune -f