name: ğŸš€ Self-hosted Auto Deploy

on:
  push:
    branches: [ "main" ]  # main ë¸Œëœì¹˜ì— ì˜¬ë¦´ ë•Œë§Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: self-hosted  # ğŸ‘ˆ [í•µì‹¬] ì•„ê¹Œ ì„œë²„ì— ì‹¬ì€ ë¡œë´‡ì´ ì‘ë™í•©ë‹ˆë‹¤!
    
    steps:
      - name: 1. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v3
      
      - name: 2. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (.env)
        # ê¹ƒí—ˆë¸Œ Secrets(ENV_FILE)ì— ì €ì¥ëœ ë‚´ìš©ì„ êº¼ë‚´ì„œ ì„œë²„ì— .env íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.
        # (ì£¼ì˜: ê¹ƒí—ˆë¸Œ Settings -> Secretsì— 'ENV_FILE'ì´ ë“±ë¡ë˜ì–´ ìˆì–´ì•¼ í•¨!)
        run: echo "${{ secrets.ENV_FILE }}" > .env

      - name: 3. Docker Compose ì¬ì‹¤í–‰
        run: |
          echo "ğŸ”¥ ê¸°ì¡´ ì„œë²„ ì¢…ë£Œ..."
          sudo docker compose down
          
          echo "ğŸ—ï¸ ìƒˆë¡œ ë¹Œë“œí•˜ê³  ì‹œì‘..."
          sudo docker compose up -d --build
          
          echo "ğŸ§¹ ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì²­ì†Œ..."
          sudo docker image prune -f